// AI Tools Database - now loaded from backend
let aiTools = [];

// AI Tool Recommendations Database (kept for reference, but backend now handles recommendations)
const toolRecommendations = {
    "tutoring": ["Khan Academy AI Tutor", "Socratic by Google", "Class Companion"],
    "writing": ["Grammarly for Education", "QuillBot", "Wordtune", "Otio", "Eduaide.AI"],
    "math": ["Photomath", "Khan Academy AI Tutor"],
    "language": ["Duolingo"],
    "assessment": ["Turnitin", "Quizlet", "QuillBot", "Quizizz", "Class Companion", "Eduaide.AI"],
    "research": ["Semantic Scholar", "Otio", "Paperpile", "Diffit"],
    "quiz": ["Quizlet", "Quizizz"],
    "homework": ["Socratic by Google", "Khan Academy AI Tutor"],
    "essay": ["Grammarly for Education", "Turnitin", "Class Companion"],
    "study": ["Quizlet", "Khan Academy AI Tutor", "Xmind", "Diffit"],
    "Administration": ["SAP Analytics Cloud", "Numerous AI", "BrightBytes", "Civitas Learning"],
    "Business": ["SAP Analytics Cloud", "Numerous AI", "BrightBytes", "Civitas Learning", "Fireflies AI", "Notion", "Zapier"]
};

// Initialize the application
document.addEventListener('DOMContentLoaded', function () {
    fetchTools();
    setupEventListeners();
});

// Fetch tools from backend
async function fetchTools() {
    try {
        const response = await fetch('http://localhost:3000/api/tools');
        if (!response.ok) throw new Error('Failed to fetch tools');
        aiTools = await response.json();
        console.log(`Loaded ${aiTools.length} tools from backend`);
        renderTools();
    } catch (error) {
        console.error('Error fetching tools:', error);
        document.getElementById('toolsGrid').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Unable to load tools. Please make sure the backend server is running.</p>';
    }
}

function setupEventListeners() {
    // Mobile menu toggle
    const menuToggle = document.querySelector('.menu-toggle');
    const navLinks = document.querySelector('.nav-links');

    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            navLinks.classList.toggle('active');
        });
    }

    // Form submission
    const submitForm = document.getElementById('submitForm');
    if (submitForm) {
        submitForm.addEventListener('submit', handleSubmitTool);
    }

    // Smooth scrolling for navigation
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Active navigation highlighting
    window.addEventListener('scroll', updateActiveNavigation);
}

function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }
}

function updateActiveNavigation() {
    const sections = document.querySelectorAll('section[id]');
    const navLinks = document.querySelectorAll('.nav-link');

    let current = '';
    sections.forEach(section => {
        const sectionTop = section.offsetTop;
        const sectionHeight = section.clientHeight;
        if (scrollY >= (sectionTop - 200)) {
            current = section.getAttribute('id');
        }
    });

    navLinks.forEach(link => {
        link.classList.remove('active');
        const stars = '★'.repeat(Math.floor(tool.rating)) + '☆'.repeat(5 - Math.floor(tool.rating));

        modalBody.innerHTML = `
        <h2>${tool.name}</h2>
        <div class="tool-category" style="display: inline-block; margin: 1rem 0;">
          ${Array.isArray(tool.category)
                ? tool.category.map(getCategoryName).join(', ')
                : getCategoryName(tool.category)
            }
        </div>
        <p style="margin: 1rem 0; line-height: 1.6;">${tool.description}</p>

        <div style="margin: 1.5rem 0;">
            <h3 style="margin-bottom: 0.5rem;">Key Features:</h3>
            <ul style="margin-left: 1rem;">
                ${tool.features.map(feature => `<li>${feature}</li>`).join('')}
            </ul>
        </div>

        <div style="margin: 1.5rem 0;">
            <h3 style="margin-bottom: 0.5rem;">Education Focus:</h3>
            <p style="color: var(--text-secondary);">${tool.educationFocus}</p>
        </div>

        <div style="margin: 1.5rem 0;">
            <div class="rating">
                <span class="stars">${stars}</span>
                <span class="rating-text">${tool.rating} out of 5 (${tool.reviews} reviews)</span>
            </div>
        </div>

        <div style="margin-top: 2rem;">
            <a href="${tool.url}" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                <i class="fas fa-external-link-alt"></i>
                Visit Tool
            </a>
        </div>
    `;

        modal.style.display = 'block';
    }

function closeModal() {
            const modal = document.getElementById('toolModal');
            modal.style.display = 'none';
        }

// Close modal when clicking outside
window.onclick = function (event) {
            const modal = document.getElementById('toolModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

function filterTools() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const ratingFilter = parseFloat(document.getElementById('ratingFilter').value) || 0;

            const filteredTools = aiTools.filter(tool => {
                const matchesSearch = tool.name.toLowerCase().includes(searchTerm) ||
                    tool.description.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || (Array.isArray(tool.category) ? tool.category.includes(categoryFilter) : tool.category === categoryFilter);
                const matchesRating = tool.rating >= ratingFilter;

                return matchesSearch && matchesCategory && matchesRating;
            });

            renderTools(filteredTools);
        }

// AI Tool Finder - uses backend for recommendations
async function findAITools() {
            const description = document.getElementById('problemDescription').value;
            const resultsContainer = document.getElementById('finderResults');

            if (!description.trim()) {
                resultsContainer.innerHTML = '<p class="loading">Please describe what you need help with.</p>';
                return;
            }

            // Show loading state
            resultsContainer.innerHTML = '<div class="loading">Finding the best AI tools for you...</div>';

            try {
                // Call backend endpoint
                const response = await fetch('http://localhost:3000/recommend-tools', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        problemDescription: description
                    }),
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }

                const data = await response.json();
                const recommendedIds = data.recommendedIds;

                // Find the full tool objects from the IDs returned by the LLM
                const recommendedTools = aiTools.filter(tool => recommendedIds.includes(tool.id));

                // Display the results
                displayRecommendations(recommendedTools, resultsContainer);

            } catch (error) {
                console.error('Failed to fetch recommendations:', error);
                resultsContainer.innerHTML = '<p class="no-results">Sorry, something went wrong. Please try again later.</p>';
            }
        }

function displayRecommendations(recommendations, container) {
            if (recommendations.length === 0) {
                container.innerHTML = `
            <div class="result-card">
                <h3>No specific matches found</h3>
                <p>Try describing your needs differently, or browse our full directory below to find tools that might help.</p>
                <button class="btn btn-secondary" onclick="scrollToSection('directory')" style="margin-top: 1rem;">
                    <i class="fas fa-compass"></i>
                    Browse All Tools
                </button>
            </div>
        `;
                return;
            }

            const resultsHTML = recommendations.map(tool => {
                const stars = '★'.repeat(Math.floor(tool.rating));
                return `
            <div class="result-card" onclick="showToolDetails(${JSON.stringify(tool).replace(/"/g, '&quot;')})">
                <h3>${tool.name}</h3>
                <div class="tool-category" style="display: inline-block; margin: 0.5rem 0;">${getCategoryName(tool.category)}</div>
                <p>${tool.description}</p>
                <div style="margin-top: 1rem;">
                    <span class="stars">${stars}</span>
                    <span class="rating-text">${tool.rating} (${tool.reviews} reviews)</span>
                </div>
                <p style="margin-top: 0.5rem; color: var(--primary-color); font-weight: 500;">
                    <i class="fas fa-graduation-cap"></i> ${tool.educationFocus}
                </p>
            </div>
        `;
            }).join('');

            container.innerHTML = `
        <h3 style="margin-bottom: 1rem; text-align: center;">Recommended AI Tools for You</h3>
        ${resultsHTML}
    `;
        }

function handleSubmitTool(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const toolData = {
                name: formData.get('toolName'),
                url: formData.get('toolUrl'),
                category: formData.get('toolCategory'),
                description: formData.get('toolDescription'),
                email: formData.get('submitterEmail')
            };

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;

            // Simulate submission
            setTimeout(() => {
                alert('Thank you for submitting! We\'ll review your tool suggestion and add it to our directory if approved.');
                e.target.reset();
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 2000);
        }

// Add some visual enhancements
document.addEventListener('DOMContentLoaded', function () {
            // Add hover effects to cards
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            });

            // Observe all cards for animation
            document.querySelectorAll('.tool-card, .result-card').forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(card);
            });
        });

    // --- Chatbot Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const chatBubble = document.querySelector('.chat-bubble');
        const chatWindow = document.querySelector('.chat-window');
        const closeChatBtn = document.querySelector('.close-chat');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.querySelector('.chat-messages');

        let conversationHistory = [
            { role: 'user', parts: 'Hello' },
            { role: 'model', parts: 'Hello! How can I help you today?' }
        ];

        // Toggle chat window
        chatBubble.addEventListener('click', () => {
            chatWindow.classList.toggle('active');
        });

        closeChatBtn.addEventListener('click', () => {
            chatWindow.classList.remove('active');
        });

        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if (!userInput) return;

            // Add user message to UI and history
            addMessage(userInput, 'user');
            conversationHistory.push({ role: 'user', parts: userInput });
            chatInput.value = '';

            try {
                const response = await fetch('http://localhost:3000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversationHistory: conversationHistory
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }

                const data = await response.json();
                const botReply = data.reply;

                // Add bot reply to UI and history
                addMessage(botReply, 'bot');
                conversationHistory.push({ role: 'model', parts: botReply });

            } catch (error) {
                console.error("Chatbot fetch error:", error);
                addMessage("Sorry, I'm having trouble connecting. Please try again later.", 'bot');
            }
        });

        function addMessage(text, sender, isTyping = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);
            if (isTyping) messageElement.classList.add('typing');
            messageElement.textContent = text;
            chatMessages.appendChild(messageElement);
            // Scroll to the bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });